---
title: "Untitled"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load_packages_and_data}
library(readr)
library(dplyr)
library(lubridate)
library(data.world)
library(ggplot2)

mlb_ds <- "https://data.world/dataquest/mlb-game-logs"

query <- "SELECT date, h_name, v_name, length_minutes, length_outs, h_pitchers_used, v_pitchers_used, h_league, v_league from game_logs where date > '2000-01-01'"

test_q <- data.world::qry_sql(query)

yrly <- data.world::query(test_q, dataset = mlb_ds) %>%
  mutate(year = year(date)) %>%
  filter(length_outs >= 51) %>% # drop any games that were less than 8.5 innings
  mutate(min_per_out = length_minutes/length_outs,
         weird_num_outs = length_outs %% 3,
         per_9_inn = length_outs / 54, # normalize for 9 inning game 
         half_innings = length_outs/3,
         min_per_9_inn = length_minutes / per_9_inn,
         total_pitchers_used = h_pitchers_used + v_pitchers_used,
         pitcher_changes_per_9_inn = (total_pitchers_used - 2)/per_9_inn) # normalize for number of half innings
```

I don't see any real difference between AL, NL, and Interleague games when just looking at the length of the games overall.

```{r longest_games}
# compare al, nl, and inter-league
game_lengths <- yrly %>%
  select(date, v_name, v_league, h_name, h_league, length_minutes, length_outs) %>%
  mutate(year = as.factor(year(date)),
         league = case_when(v_league == "NL" & h_league == "NL" ~ "NL",
           v_league == "AL" & h_league == "AL" ~ "AL",
           v_league == "AL" & h_league == "NL" ~ "Interleague",
           v_league == "NL" & h_league == "AL" ~ "Interleague")) 

game_lengths %>%
  filter(length_outs <= 54) %>% #just look at 9-inning games for now
  ggplot(aes(x = year, y = length_minutes)) +
  geom_violin(draw_quantiles = c(.5)) # show the median

```
Are games getting longer? Is there an overall trend? 
We will look by number of half-innings in the game because we'll assume that the amount of time to switch sides is significant. Just counting the number of outs would obscure that.

```{r}
yrly_summary <- yrly %>%
  filter(weird_num_outs == 0) %>%
  group_by(year) %>%
  summarize(mean_min_per_9_inn = mean(min_per_9_inn),
            mean_pitcher_changes_per_9_inn = mean(pitcher_changes_per_9_inn) ) 

yrly_summary %>%
  ggplot(aes(x = year, y = mean_min_per_9_inn)) +
  geom_point() +
  geom_smooth(method = "lm") 
```

finding: more pitchers are being used


```{r}
yrly_summary %>%
  ggplot(aes(x = year, y = mean_pitcher_changes_per_9_inn * 18)) +
  geom_point() +
  geom_smooth(method = "lm")
```

does this explain all the variation in game length? One thing we know is that not every pitching adds length to the game (only those that are within the inning. This dataset doesn't have that level of granularity). 
Other things to look at: 
* pitches per AB (walks and Ks: are fewer balls being put in play?)


Why did the year 2000 have the lowest number of pitcher changes, but it was 4th in min per 9 innings?

